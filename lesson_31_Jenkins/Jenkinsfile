pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/homework31']],
                          userRemoteConfigs: [[url: 'https://github.com/MarianaKhl/qa_automation_python.git']]])
            }
        }

        stage('Install Dependencies') {
            steps {
                sh """
                    echo "Creating virtual environment with Python3..."
                    python3 -m venv venv
                    echo "Activating virtual environment..."
                    source venv/bin/activate

                    echo "Checking Python and pip versions..."
                    python3 --version
                    pip3 --version

                    echo "Ensuring pip is installed and up to date..."
                    python3 -m ensurepip --upgrade
                    pip3 install --upgrade pip

                    echo "Checking for requirements.txt..."
                    ls -la requirements.txt

                    echo "Installing dependencies from requirements.txt..."
                    if [ -f requirements.txt ]; then
                        pip3 install -r requirements.txt
                    else
                        echo "ERROR: requirements.txt not found!"
                        exit 1
                    fi
                """
            }
        }

        stage('Run Tests') {
            steps {
                sh """
                    echo "Activating virtual environment for tests..."
                    source venv/bin/activate
                    echo "Making run_tests.sh executable..."
                    chmod +x run_tests.sh
                    echo "Running tests with Python3..."
                    ./run_tests.sh
                """
            }
        }

        stage('Publish Test Results') {
            steps {
                echo "Publishing test results..."
                junit 'allure-results/*.xml'
            }
        }
    }
}
