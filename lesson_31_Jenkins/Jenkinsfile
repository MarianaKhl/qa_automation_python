pipeline {
    agent any
    tools {
        allure 'Allure CMD'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/homework31']],
                          userRemoteConfigs: [[url: 'https://github.com/MarianaKhl/qa_automation_python.git']]])
                sh """
                    echo "After checkout, verifying working directory and its contents:"
                    pwd
                    ls -la
                """
            }
        }

        stage('Install Dependencies') {
            steps {
                sh """
                    echo "Creating virtual environment with Python3..."
                    python3 -m venv venv
                    venv/bin/python3 -m pip install --upgrade pip

                    echo "Checking for requirements.txt in lesson_31_Jenkins..."
                    if [ -f lesson_31_Jenkins/requirements.txt ]; then
                        venv/bin/python3 -m pip install -r lesson_31_Jenkins/requirements.txt
                    else
                        echo "ERROR: requirements.txt not found!"
                        exit 1
                    fi
                """
            }
        }

        stage('Run Tests') {
            steps {
                sh """
                    echo "Creating directories for Allure results..."
                    mkdir -p lesson_31_Jenkins/allure-results
                    mkdir -p lesson_31_Jenkins/allure-report

                    echo "Running tests with pytest..."
                    chmod +x lesson_31_Jenkins/run_tests.sh
                    ./lesson_31_Jenkins/run_tests.sh
                """
            }
        }

        stage('Publish Test Results') {
            steps {
                junit 'lesson_31_Jenkins/allure-results/results.xml'
            }
        }
    }

    post {
        always {
            echo "Generating Allure report..."
            allure includeProperties: false, jdk: '', results: [[path: 'lesson_31_Jenkins/allure-results']]
        }
    }
}



