pipeline {
    agent any

    stages {
        stage('Checkout Code') {
            steps {
                checkout([$class: 'GitSCM',
                          branches: [[name: '*/homework31']],
                          userRemoteConfigs: [[url: 'https://github.com/MarianaKhl/qa_automation_python.git']]])
                sh """
                    echo "After checkout, verifying working directory and its contents:"
                    pwd
                    ls -la
                """
            }
        }

        stage('Install Dependencies') {
            steps {
                sh """
                    echo "Creating virtual environment with Python3..."
                    python3 -m venv venv
                    echo "Activating virtual environment..."
                    source venv/bin/activate

                    echo "Checking Python and pip versions..."
                    python3 --version
                    pip3 --version

                    echo "Ensuring pip is installed and up to date..."
                    python3 -m ensurepip --upgrade
                    pip3 install --upgrade pip

                    echo "Checking for requirements.txt in lesson_31_Jenkins..."
                    if [ -f lesson_31_Jenkins/requirements.txt ]; then
                        pip3 install -r lesson_31_Jenkins/requirements.txt
                    else
                        echo "ERROR: requirements.txt not found!"
                        exit 1
                    fi
                """
            }
        }

        stage('Run Tests') {
            steps {
                sh """
                    chmod +x lesson_31_Jenkins/run_tests.sh
                    ./lesson_31_Jenkins/run_tests.sh
                """
            }
        }

        stage('Publish Test Results') {
            steps {
                junit 'lesson_31_Jenkins/allure-results/*.xml'
            }
        }
    }

    post {
        always {
            echo "Generating Allure report..."
            allure includeProperties: false, jdk: '', results: [[path: 'lesson_31_Jenkins/allure-results']]
        }
    }
}


